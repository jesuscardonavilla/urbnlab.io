-- ============================================================
-- MONTERREY CAMPAIGN SETUP
-- ============================================================
-- This script will use the existing Monterrey org if it exists,
-- or create a new one if it doesn't.

-- 1. Get or create Monterrey org ID
DO $$
DECLARE
  monterrey_org_id UUID;
  monterrey_boundary_id UUID := 'b2000000-0000-0000-0000-000000000001';
  monterrey_campaign_id UUID := 'c2000000-0000-0000-0000-000000000001';
BEGIN
  -- Get existing Monterrey org ID or create new one
  INSERT INTO orgs (id, name, slug)
  VALUES (
    'a2000000-0000-0000-0000-000000000001',
    'Monterrey',
    'monterrey'
  )
  ON CONFLICT (slug)
  DO UPDATE SET name = EXCLUDED.name
  RETURNING id INTO monterrey_org_id;

  -- If the above didn't return an ID, fetch it
  IF monterrey_org_id IS NULL THEN
    SELECT id INTO monterrey_org_id FROM orgs WHERE slug = 'monterrey';
  END IF;

  -- Create or update boundary (using actual Monterrey city limits from OpenStreetMap)
  -- Simplified from 2507 to 102 coordinate points
  INSERT INTO boundaries (id, org_id, name, geog, center_lat, center_lng, default_zoom)
  VALUES (
    monterrey_boundary_id,
    monterrey_org_id,
    'Monterrey',
    ST_GeographyFromText('SRID=4326;POLYGON((-100.38700487527127 25.79729242378517, -100.38125413992935 25.795639405152713, -100.3772362323208 25.794436422766104, -100.37443328712715 25.79366999534179, -100.36248380794076 25.788560652785044, -100.34945416195389 25.776697220080777, -100.32220659853289 25.748667980976386, -100.32104481499039 25.745305249549965, -100.32379934111052 25.73872136873713, -100.31832557001451 25.73621944947643, -100.31728398094737 25.732201659877575, -100.31720555259115 25.728105380519455, -100.30793167340353 25.717554612591567, -100.29603433552757 25.712762797304933, -100.26844368903558 25.70816977029295, -100.26678851987656 25.70226991054666, -100.2618062230518 25.700205858792035, -100.2618137093567 25.6997567772232, -100.2618330033071 25.698335750368418, -100.26186067913137 25.69622852352247, -100.26186074403554 25.693680570576714, -100.26188118516475 25.691999141324747, -100.26197450987456 25.689270780349197, -100.26175285333177 25.68346421758996, -100.26386142004505 25.681777259738677, -100.26832699770452 25.681512979996423, -100.27140694070225 25.681135309478847, -100.27456290955091 25.67877682998852, -100.27415842871264 25.67640046089426, -100.27366789725663 25.674331927567916, -100.27158418816313 25.6708101791966, -100.27136550084064 25.667556687331643, -100.26986224872303 25.66156111052671, -100.27025334997032 25.659439460504466, -100.27280184949412 25.65704000006452, -100.27343626723007 25.654877010294257, -100.2704846493749 25.652634050633306, -100.26809412862363 25.650646167409086, -100.26980527888745 25.648853910496296, -100.27356182850389 25.647585290766262, -100.27431853860567 25.646035719846157, -100.27348123793138 25.643643590820915, -100.27238135004474 25.642759061042003, -100.26942985845126 25.640914379799085, -100.26922941127508 25.6394045299443, -100.27010668749752 25.635898179840808, -100.27159214676263 25.63306216879282, -100.27076744716904 25.63048456943331, -100.27074101186966 25.6299659210905, -100.270778538465 25.62874869054467, -100.27125888947668 25.627110549627186, -100.27216651002382 25.62461984950813, -100.26937268560738 25.621866053746643, -100.2663564900974 25.622171949052863, -100.24207523197107 25.624772723879083, -100.2302975187555 25.599205620251723, -100.22212399862661 25.58750081990006, -100.21428116812123 25.576299381443146, -100.20143230914992 25.55561048994303, -100.1834896192571 25.536191678920414, -100.17088914010228 25.51423301943257, -100.18315834886789 25.519711742913774, -100.18669046029932 25.52057667948498, -100.18886051701419 25.519098350510387, -100.19178833998073 25.52041400046776, -100.19812733995609 25.514920659660422, -100.20666381998755 25.51403330894156, -100.21289911876143 25.507055201298524, -100.22031976974462 25.50203829233277, -100.23001696809156 25.507572911089465, -100.2537687203051 25.48397048960336, -100.27621463038643 25.5152020789572, -100.31492525995851 25.557553229425366, -100.33691409034927 25.58301096936348, -100.31891621888185 25.635628519587847, -100.31818315175256 25.63821386038552, -100.31577746271593 25.640717516463067, -100.31463895679806 25.642815779789572, -100.3131930802866 25.64502028918796, -100.32390613912105 25.653422319411966, -100.32708186068845 25.653074348410737, -100.32917421905802 25.65418916988242, -100.3334275836496 25.65675232855574, -100.3446932489824 25.66234420720477, -100.34747296449376 25.663359450723433, -100.35156621925849 25.6641522543743, -100.36524574869618 25.66903983195926, -100.37213868001916 25.667974539779152, -100.3835013156915 25.66909469065333, -100.39669393868192 25.67396811174711, -100.39799878056319 25.677621598917526, -100.4036849504551 25.70249094968622, -100.42166280004669 25.711942379612214, -100.43463664802628 25.739049429621957, -100.42542939932773 25.76302152117437, -100.41866101437822 25.780287756123, -100.41740423409581 25.783559877319128, -100.41546742943211 25.7887070894904, -100.40388968543652 25.79638519223541, -100.39696066774437 25.79341318741978, -100.38978671218064 25.794587515755396, -100.38700487527127 25.79729242378517))'),
    25.6866,
    -100.3161,
    12
  )
  ON CONFLICT (id)
  DO UPDATE SET
    org_id = EXCLUDED.org_id,
    name = EXCLUDED.name,
    geog = EXCLUDED.geog,
    center_lat = EXCLUDED.center_lat,
    center_lng = EXCLUDED.center_lng,
    default_zoom = EXCLUDED.default_zoom;

  -- Back-fill geog_json
  UPDATE boundaries
  SET geog_json = ST_AsGeoJSON(geog)::text
  WHERE id = monterrey_boundary_id AND geog_json IS NULL;

  -- Create or update campaign
  INSERT INTO campaigns (id, org_id, boundary_id, title, description, start_at, end_at, enabled_categories)
  VALUES (
    monterrey_campaign_id,
    monterrey_org_id,
    monterrey_boundary_id,
    'Centro Urbano',
    'Identifica problemas de movilidad en Monterrey para mejorar la infraestructura del centro urbano.',
    now() - INTERVAL '5 days',
    now() + INTERVAL '52 days',
    ARRAY['crosswalk_needed','bike_gap','sidewalk_ada','speeding_near_miss','tourism_pressure','climate_stress']
  )
  ON CONFLICT (id)
  DO UPDATE SET
    org_id = EXCLUDED.org_id,
    boundary_id = EXCLUDED.boundary_id,
    title = EXCLUDED.title,
    description = EXCLUDED.description,
    start_at = EXCLUDED.start_at,
    end_at = EXCLUDED.end_at,
    enabled_categories = EXCLUDED.enabled_categories;

  -- Output the org ID being used
  RAISE NOTICE 'Using Monterrey org ID: %', monterrey_org_id;
END $$;
